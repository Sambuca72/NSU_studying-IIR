SELECT M1.COMPANY AS COMPANY, GROUP_CONCAT(DISTINCT MA1.WARE) AS MATERIALS, 
	P1.RECIPE_ID AS RECIPE_ID1, P1.WARE AS INTERMEDIATE_PRODUCT, MA2.RECIPE_ID AS RECIPE_ID2,
    GROUP_CONCAT(DISTINCT P2.WARE) AS PRODUCTS, 
    ( '(' || GROUP_CONCAT(DISTINCT MA1.WARE ) || ')-[' || P1.RECIPE_ID || ']->(' || P1.WARE || ')-[' || MA2.RECIPE_ID || ']->(' || GROUP_CONCAT(DISTINCT P2.WARE) || ')') AS CHAIN

FROM  MANUFACTURER M1
INNER JOIN PRODUCT P1 
	ON P1.RECIPE_ID = M1.RECIPE_ID
INNER JOIN MATERIAL MA2 
	ON MA2.WARE = P1.WARE
INNER JOIN MANUFACTURER M2 
	ON M2.RECIPE_ID = MA2.RECIPE_ID AND M2.COMPANY = M1.COMPANY
INNER JOIN MATERIAL MA1 
	ON MA1.RECIPE_ID = P1.RECIPE_ID
INNER JOIN PRODUCT P2 
	ON P2.RECIPE_ID = MA2.RECIPE_ID

GROUP BY 
    M1.COMPANY, P1.RECIPE_ID, P1.WARE, MA2.RECIPE_ID
ORDER BY 
    M1.COMPANY, P1.RECIPE_ID, MA2.RECIPE_ID;